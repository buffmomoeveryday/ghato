{% extends "base.html" %}
{% block title %}
{{ purchase.invoice_number }} | {{ super }}
{% endblock title %}
{% block main %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">{{ purchase.supplier.name | upper }} - Reference: {{ purchase.invoice_number }}</h1>
    <hr class="mb-6">

    <!-- Purchase Information -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Invoice Detail</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-200 text-gray-600 uppercase text-sm">
                    <tr>
                        <th class="py-3 px-6 text-left">Purchase Invoice Number</th>
                        <th class="py-3 px-6 text-left">Supplier</th>
                        <th class="py-3 px-6 text-left">Purchase Date</th>
                        <th class="py-3 px-6 text-left">Total Amount</th>
                        <th class="py-3 px-6 text-left">Received Date</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700">
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left whitespace-nowrap">{{ purchase.invoice_number }}</td>
                        <td class="py-3 px-6 text-left">{{ purchase.supplier.name }}</td>
                        <td class="py-3 px-6 text-left">{{ purchase.purchase_date }}</td>
                        <td class="py-3 px-6 text-left">Rs. {{ purchase.total_amount }}</td>
                        <td class="py-3 px-6 text-left">{{ purchase.received_date }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Purchase Items -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Purchase Items</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-200 text-gray-600 uppercase text-sm">
                    <tr>
                        <th class="py-3 px-6 text-left">Product</th>
                        <th class="py-3 px-6 text-left">Quantity</th>
                        <th class="py-3 px-6 text-left">Price</th>
                        <th class="py-3 px-6 text-left">Received Quantity</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700">
                    {% for item in purchase_items %}
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left">{{ item.product.name }} ({{ item.product.sku }})</td>
                        <td class="py-3 px-6 text-left">{{ item.quantity }}</td>
                        <td class="py-3 px-6 text-left">Rs. {{ item.price }}</td>
                        <td class="py-3 px-6 text-left">{{ item.received_quantity }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="py-3 px-6 text-left text-gray-500">No items found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Analytics</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
                <h3 class="text-xl font-semibold mb-4">Purchase Amount Over Time</h3>
                <div id="purchase-amount-over-time-chart"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-4">Top Purchased Products</h3>
                <div id="top-purchased-products-chart"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-4">Supplier Contributions</h3>
                <div id="supplier-contributions-chart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock main %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Purchase Amount Over Time
    var purchaseAmountOptions = {
        series: [{
            name: "Total Amount",
            data: JSON.parse('{{ purchase_amounts|escapejs }}')
        }],
        chart: {
            type: 'line',
            height: 350,
        },
        xaxis: {
            categories: JSON.parse('{{ purchase_dates|escapejs }}'),
            title: {
                text: 'Date'
            }
        },
        yaxis: {
            title: {
                text: 'Total Amount'
            }
        }
    };
    var purchaseAmountChart = new ApexCharts(document.querySelector("#purchase-amount-over-time-chart"), purchaseAmountOptions);
    purchaseAmountChart.render();

    // Top Purchased Products
    var topProductsOptions = {
        series: [{
            name: "Quantity",
            data: JSON.parse('{{ top_products_quantities|escapejs }}')
        }],
        chart: {
            type: 'bar',
            height: 350,
        },
        xaxis: {
            categories: JSON.parse('{{ top_products_names|escapejs }}'),
            title: {
                text: 'Products'
            }
        },
        yaxis: {
            title: {
                text: 'Quantity'
            }
        }
    };
    var topProductsChart = new ApexCharts(document.querySelector("#top-purchased-products-chart"), topProductsOptions);
    topProductsChart.render();

    // Supplier Contributions
    var supplierContributionsOptions = {
        series: JSON.parse('{{ suppliers_amounts|escapejs }}'),
        chart: {
            type: 'pie',
            height: 350,
        },
        labels: JSON.parse('{{ suppliers_names|escapejs }}'),
        colors: ['#4299E1', '#48BB78', '#ED8936', '#ECC94B', '#ED64A6', '#9F7AEA'],
        legend: {
            position: 'bottom'
        }
    };
    var supplierContributionsChart = new ApexCharts(document.querySelector("#supplier-contributions-chart"), supplierContributionsOptions);
    supplierContributionsChart.render();
});
</script>
{% endblock js %}
